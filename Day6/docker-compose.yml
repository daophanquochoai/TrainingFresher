services:
    # PostgreSQL Database
    postgres:
        image: postgres:16-alpine
        container_name: postgres_db
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-admin}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin}
            POSTGRES_DB: ${POSTGRES_DB:-db}
        ports:
            - "${POSTGRES_PORT:-5432}:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-admin}"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - app-network

    redis:
        image: redis:latest
        container_name: redis
        ports:
            - "6379:6379"
        restart: always
        networks:
            - app-network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s

    productservice-http:
        build:
            context: ./productservice
            dockerfile: Dockerfile
        container_name: productservice_http
        command: ["./http-server", "-port", "${PRODUCT_HTTP_PORT:-8080}"]
        ports:
            - "${PRODUCT_HTTP_PORT:-8080}:8080"
        environment:
            # App Config - Viper sẽ map các biến này vào config
            APP_NAME: ${PRODUCT_APP_NAME:-product}
            APP_PORT: ${PRODUCT_HTTP_PORT:-8080}
            APP_GRPC: ${PRODUCT_GRPC_PORT:-9000}

            # Database Config
            DB_HOST: ${DB_HOST:-postgres}
            DB_PORT: ${DB_PORT:-5432}
            DB_USER: ${POSTGRES_USER:-admin}
            DB_PASS: ${POSTGRES_PASSWORD:-admin}
            DB_NAME: ${POSTGRES_DB:-db}

            # Redis Config - Note: config struct expects "host" but we use REDIS_HOST
            REDIS_HOST: ${REDIS_HOST:-redis}:${REDIS_PORT:-6379}
            REDIS_PASSWORD: ${REDIS_PASSWORD:-}
            REDIS_DB: ${REDIS_DB:-0}
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "wget", "--tries=1", "http://localhost:8080/health"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        networks:
            - app-network
        restart: unless-stopped

    productservice-grpc:
        build:
            context: ./productservice
            dockerfile: Dockerfile
        container_name: productservice_grpc
        command: ["./grpc-server"]
        ports:
            - "${PRODUCT_GRPC_PORT:-9090}:9090"
        environment:
            # App Config
            APP_NAME: ${PRODUCT_APP_NAME:-product}
            APP_GRPC: ${PRODUCT_GRPC_PORT:-9000}

            # Database Config
            DB_HOST: ${DB_HOST:-postgres}
            DB_PORT: ${DB_PORT:-5432}
            DB_USER: ${POSTGRES_USER:-admin}
            DB_PASS: ${POSTGRES_PASSWORD:-admin}
            DB_NAME: ${POSTGRES_DB:-db}

            # Redis Config
            REDIS_HOST: ${REDIS_HOST:-redis}:${REDIS_PORT:-6379}
            REDIS_PASSWORD: ${REDIS_PASSWORD:-}
            REDIS_DB: ${REDIS_DB:-0}
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        healthcheck:
            test: ["CMD-SHELL", "nc -z localhost 9090 || exit 1"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        networks:
            - app-network
        restart: unless-stopped

    categoryservice-http:
        build:
            context: ./categoryservice
            dockerfile: Dockerfile
        container_name: categoryservice_http
        command: ["./http-server", "-port", "${CATEGORY_HTTP_PORT:-8081}"]
        ports:
            - "${CATEGORY_HTTP_PORT:-8081}:8081"
        environment:
            # App Config
            APP_NAME: ${CATEGORY_APP_NAME:-category}
            APP_PORT: ${CATEGORY_HTTP_PORT:-8081}
            APP_GRPC_PORT: ${PRODUCT_GRPC_PORT:-9090}
            APP_GRPC_HOST: ${PRODUCT_GRPC_HOST:-productservice-grpc}

            # Database Config
            DB_HOST: ${DB_HOST:-postgres}
            DB_PORT: ${DB_PORT:-5432}
            DB_USER: ${POSTGRES_USER:-admin}
            DB_PASS: ${POSTGRES_PASSWORD:-admin}
            DB_NAME: ${POSTGRES_DB:-db}

            # Redis Config
            REDIS_HOST: ${REDIS_HOST:-redis}:${REDIS_PORT:-6379}
            REDIS_PASSWORD: ${REDIS_PASSWORD:-}
            REDIS_DB: ${REDIS_DB:-0}
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            productservice-grpc:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "wget", "--tries=1", "http://localhost:8081/health"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        networks:
            - app-network
        restart: unless-stopped

volumes:
    postgres_data:
    redis_data:

networks:
    app-network:
        driver: bridge
